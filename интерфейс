import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import customtkinter as ctk
from PIL import Image, ImageTk
import torch
import torch.nn as nn
from torchvision import models, transforms
import os
import glob
import json
import threading
import time
import pandas as pd
from datetime import datetime

ctk.set_appearance_mode("light")
ctk.set_default_color_theme("blue")


class AdvancedDefectClassifier:
    def __init__(self, model_path=None, device=None):
        if device is None:
            self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
        else:
            self.device = device

        if model_path is None:
            model_path = self._find_model()

        self.model_path = model_path
        self.model = None
        self.class_names = ['crack', 'corrosion', 'normal']
        self.transform = None

        if model_path and os.path.exists(model_path):
            self._load_model(model_path)
        else:
            raise FileNotFoundError("‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ (.pth) –≤ –ø–∞–ø–∫—É models/")

    def _find_model(self):
        primary_paths = [
            "models/–ø–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å.pth",
            "models/–º–æ–¥–µ–ª—å.pth",
            "–ø–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å.pth",
            "–º–æ–¥–µ–ª—å.pth"
        ]

        for path in primary_paths:
            if os.path.exists(path):
                return path

        for root, dirs, files in os.walk("."):
            for file in files:
                if file.endswith('.pth') or file.endswith('.pt'):
                    if 'cache' in root or '__pycache__' in root:
                        continue
                    return os.path.join(root, file)

        return None

    def _load_model(self, model_path):
        try:
            json_path = model_path.replace('.pth', '.json').replace('.pt', '.json')
            if os.path.exists(json_path):
                try:
                    with open(json_path, 'r', encoding='utf-8') as f:
                        metadata = json.load(f)
                    if 'classes' in metadata:
                        self.class_names = metadata['classes']
                except:
                    pass

            try:
                model = models.efficientnet_b3(weights=None)
            except:
                model = models.efficientnet_b3(pretrained=False)

            num_features = model.classifier[1].in_features
            model.classifier = nn.Sequential(
                nn.Dropout(0.4),
                nn.Linear(num_features, 512),
                nn.ReLU(),
                nn.BatchNorm1d(512),
                nn.Dropout(0.3),
                nn.Linear(512, 256),
                nn.ReLU(),
                nn.BatchNorm1d(256),
                nn.Dropout(0.2),
                nn.Linear(256, len(self.class_names))
            )

            try:
                state_dict = torch.load(model_path, map_location=self.device, weights_only=True)
                model.load_state_dict(state_dict)
            except:
                try:
                    state_dict = torch.load(model_path, map_location=self.device)

                    if 'state_dict' in state_dict:
                        model.load_state_dict(state_dict['state_dict'])
                    else:
                        model.load_state_dict(state_dict)
                except Exception:
                    raise RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏")

            self.model = model
            self.model.to(self.device)
            self.model.eval()

            self.transform = transforms.Compose([
                transforms.Resize((256, 256)),
                transforms.ToTensor(),
                transforms.Normalize(mean=[0.485, 0.456, 0.406],
                                     std=[0.229, 0.224, 0.225])
            ])

        except Exception:
            raise RuntimeError("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏")

    def predict_image(self, image_path, confidence_threshold=0.6):
        try:
            if not os.path.exists(image_path):
                return None, 0.0, None

            if self.model is None:
                raise RuntimeError("–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞")

            image = Image.open(image_path).convert('RGB')
            input_tensor = self.transform(image).unsqueeze(0).to(self.device)

            with torch.no_grad():
                outputs = self.model(input_tensor)
                probabilities = torch.nn.functional.softmax(outputs, dim=1)
                confidence, predicted = torch.max(probabilities, 1)

            if predicted.item() < len(self.class_names):
                predicted_class = self.class_names[predicted.item()]
            else:
                predicted_class = "unknown"

            confidence_value = confidence.item()

            if confidence_value < confidence_threshold:
                predicted_class = "uncertain"

            return predicted_class, confidence_value, None

        except Exception:
            return None, 0.0, None


class NeuralNetworkApp:
    def __init__(self):
        self.window = ctk.CTk()
        self.window.title("SkyChecker: –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ—â–∏–Ω –∏ –∫–æ—Ä—Ä–æ–∑–∏–∏")
        self.window.geometry("1400x800")

        try:
            self.window.tk.call('tk', 'scaling', 1.0)
        except:
            pass

        self.title_font = ctk.CTkFont(size=28, weight="bold", family="Segoe UI")
        self.heading_font = ctk.CTkFont(size=18, weight="bold", family="Segoe UI")
        self.normal_font = ctk.CTkFont(size=12, family="Segoe UI")
        self.small_font = ctk.CTkFont(size=11, family="Segoe UI")

        self.classifier = None
        self.model_status = "not_loaded"
        self.model_loading = False

        self.current_folder = None
        self.image_files = []
        self.results = []
        self.stop_analysis_flag = False

        self.colors = {
            "primary": "#4a86e8",
            "success": "#2e7d32",
            "danger": "#c62828",
            "warning": "#ff9800",
            "light_bg": "#ffffff",
            "dark_text": "#000000",
            "gray_text": "#666666",
            "border": "#dddddd",
            "table_header": "#4a86e8",
        }

        self.setup_ui()
        self.setup_status_bar()
        self.window.after(500, self.load_model_in_background)

    def load_model_in_background(self):
        def load():
            try:
                self.window.after(0, lambda: self.update_model_status("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...", "#FF9800"))
                self.window.after(0, lambda: self.status_bar.configure(text="–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏..."))

                time.sleep(0.5)

                self.classifier = AdvancedDefectClassifier()

                self.model_status = "loaded"
                self.window.after(0, lambda: self.update_model_status("‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞", "#2e7d32"))
                self.window.after(0, lambda: self.status_bar.configure(text="–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"))

            except Exception:
                self.model_status = "error"
                self.window.after(0, lambda: self.update_model_status("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "#c62828"))
                self.window.after(0, lambda: self.status_bar.configure(text="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏"))

                self.window.after(0, self.ask_for_model_path)

        threading.Thread(target=load, daemon=True).start()

    def ask_for_model_path(self):
        response = messagebox.askretrycancel(
            "–ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
            "–§–∞–π–ª –º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –•–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –º–æ–¥–µ–ª–∏ –≤—Ä—É—á–Ω—É—é?"
        )

        if response:
            self.select_model_file()

    def select_model_file(self):
        file_path = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏",
            filetypes=[("PyTorch –º–æ–¥–µ–ª–∏", "*.pth *.pt"), ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")]
        )

        if file_path:
            try:
                self.window.after(0, lambda: self.update_model_status("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...", "#FF9800"))
                self.window.after(0, lambda: self.status_bar.configure(text="–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏..."))

                self.classifier = AdvancedDefectClassifier(model_path=file_path)

                self.model_status = "loaded"
                self.window.after(0, lambda: self.update_model_status("‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞", "#2e7d32"))
                self.window.after(0, lambda: self.status_bar.configure(text="–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"))

                messagebox.showinfo("–£—Å–ø–µ—Ö", "–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å:\n{e}")

    def update_model_status(self, text, color):
        if hasattr(self, 'model_status_label'):
            self.model_status_label.configure(text=text, text_color=color)

    def setup_ui(self):
        self.tabview = ctk.CTkTabview(self.window, fg_color=self.colors["light_bg"])
        self.tabview.pack(fill="both", expand=True, padx=10, pady=10)

        self.tab_batch = self.tabview.add("üìÅ –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
        self.tab_single = self.tabview.add("üîç –û–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑")

        self.setup_batch_tab()
        self.setup_single_tab()

    def setup_batch_tab(self):
        main_container = ctk.CTkFrame(self.tab_batch, fg_color=self.colors["light_bg"])
        main_container.pack(fill="both", expand=True, padx=5, pady=5)

        left_panel = ctk.CTkFrame(main_container, width=350, fg_color=self.colors["light_bg"],
                                  border_width=1, border_color=self.colors["border"])
        left_panel.pack(side="left", fill="y", padx=(0, 10), pady=5)

        right_panel = ctk.CTkFrame(main_container, fg_color=self.colors["light_bg"])
        right_panel.pack(side="right", fill="both", expand=True, padx=5, pady=5)

        ctk.CTkLabel(left_panel, text="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–æ–º",
                     font=self.heading_font,
                     text_color=self.colors["dark_text"]).pack(pady=20, padx=20)

        model_frame = ctk.CTkFrame(left_panel, fg_color="#f0f7ff",
                                   border_width=1, border_color="#c5d9f1")
        model_frame.pack(fill="x", padx=15, pady=10)

        ctk.CTkLabel(model_frame, text="–°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–∏:",
                     font=ctk.CTkFont(weight="bold"), text_color=self.colors["dark_text"]).pack(pady=(8, 2))

        self.model_status_label = ctk.CTkLabel(model_frame, text="‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...",
                                               text_color="#FF9800",
                                               font=ctk.CTkFont(size=13, weight="bold"))
        self.model_status_label.pack(pady=(0, 8))

        ctk.CTkButton(model_frame, text="üîÑ –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å",
                      command=self.select_model_file,
                      height=30, fg_color="#8a2be2",
                      text_color="white", font=ctk.CTkFont(size=12)).pack(pady=(0, 10), padx=20)

        folder_frame = ctk.CTkFrame(left_panel, fg_color="#f9f9f9")
        folder_frame.pack(fill="x", padx=15, pady=15)

        ctk.CTkLabel(folder_frame, text="–ü–∞–ø–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏:",
                     text_color=self.colors["dark_text"]).pack(pady=(10, 5))

        self.folder_label = ctk.CTkLabel(folder_frame, text="–ù–µ –≤—ã–±—Ä–∞–Ω–∞",
                                         text_color=self.colors["gray_text"], height=30,
                                         fg_color="#f0f0f0", corner_radius=5)
        self.folder_label.pack(fill="x", padx=10, pady=5)

        ctk.CTkButton(folder_frame, text="üìÅ –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É",
                      command=self.select_folder,
                      height=38, fg_color=self.colors["primary"],
                      text_color="white").pack(pady=10, padx=10)

        settings_frame = ctk.CTkFrame(left_panel, fg_color="#f9f9f9")
        settings_frame.pack(fill="x", padx=15, pady=15)

        ctk.CTkLabel(settings_frame, text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:",
                     font=ctk.CTkFont(weight="bold"),
                     text_color=self.colors["dark_text"]).pack(pady=(10, 10))

        ctk.CTkLabel(settings_frame, text="–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:",
                     text_color=self.colors["dark_text"]).pack(anchor="w", padx=10)

        self.confidence_slider = ctk.CTkSlider(settings_frame, from_=0, to=100,
                                               number_of_steps=100,
                                               progress_color=self.colors["primary"])
        self.confidence_slider.set(60)
        self.confidence_slider.pack(fill="x", padx=10, pady=5)

        self.confidence_label = ctk.CTkLabel(settings_frame, text="60%",
                                             text_color=self.colors["dark_text"])
        self.confidence_label.pack()

        self.confidence_slider.configure(command=self.update_confidence_label)

        buttons_frame = ctk.CTkFrame(left_panel, fg_color="transparent")
        buttons_frame.pack(fill="x", padx=15, pady=20)

        ctk.CTkButton(buttons_frame, text="‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑",
                      command=self.start_batch_analysis,
                      height=45, fg_color=self.colors["success"],
                      text_color="white", font=self.heading_font).pack(fill="x", pady=5)

        self.stop_button = ctk.CTkButton(buttons_frame, text="‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
                                         command=self.stop_analysis,
                                         height=40, fg_color=self.colors["danger"],
                                         text_color="white", state="disabled")
        self.stop_button.pack(fill="x", pady=5)

        ctk.CTkButton(buttons_frame, text="üìä –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
                      command=self.export_results,
                      height=40, fg_color=self.colors["primary"],
                      text_color="white").pack(fill="x", pady=5)

        progress_frame = ctk.CTkFrame(left_panel, fg_color="transparent")
        progress_frame.pack(fill="x", padx=15, pady=20)

        ctk.CTkLabel(progress_frame, text="–ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞:",
                     text_color=self.colors["dark_text"]).pack(anchor="w")

        self.progress_bar = ctk.CTkProgressBar(progress_frame,
                                               progress_color=self.colors["primary"])
        self.progress_bar.set(0)
        self.progress_bar.pack(fill="x", pady=5)

        self.progress_label = ctk.CTkLabel(progress_frame, text="–û–∂–∏–¥–∞–Ω–∏–µ...",
                                           text_color=self.colors["gray_text"])
        self.progress_label.pack()

        ctk.CTkLabel(right_panel, text="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞",
                     font=self.heading_font,
                     text_color=self.colors["dark_text"]).pack(pady=15, anchor="w", padx=15)

        self.create_results_table(right_panel)

        preview_frame = ctk.CTkFrame(right_panel, height=220,
                                     fg_color="#f9f9f9",
                                     border_width=1,
                                     border_color=self.colors["border"])
        preview_frame.pack(fill="x", padx=15, pady=15)
        preview_frame.pack_propagate(False)

        ctk.CTkLabel(preview_frame, text="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
                     font=ctk.CTkFont(weight="bold"),
                     text_color=self.colors["dark_text"]).pack(pady=10)

        self.preview_label = ctk.CTkLabel(preview_frame,
                                          text="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ",
                                          text_color=self.colors["gray_text"])
        self.preview_label.pack(expand=True)

    def create_results_table(self, parent):
        table_container = ctk.CTkFrame(parent, fg_color=self.colors["light_bg"])
        table_container.pack(fill="both", expand=True, padx=15, pady=(0, 10))

        self.results_tree = ttk.Treeview(
            table_container,
            columns=("file", "result", "confidence", "status", "time"),
            show="headings",
            height=12
        )

        columns = [
            ("file", "–§–∞–π–ª", 350),
            ("result", "–†–µ–∑—É–ª—å—Ç–∞—Ç", 150),
            ("confidence", "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", 120),
            ("status", "–°—Ç–∞—Ç—É—Å", 180),
            ("time", "–í—Ä–µ–º—è", 100)
        ]

        for col_id, col_name, width in columns:
            self.results_tree.heading(col_id, text=col_name)
            self.results_tree.column(col_id, width=width, anchor="center")

        vsb = ttk.Scrollbar(table_container, orient="vertical",
                            command=self.results_tree.yview)
        hsb = ttk.Scrollbar(table_container, orient="horizontal",
                            command=self.results_tree.xview)

        self.results_tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)

        self.results_tree.grid(row=0, column=0, sticky="nsew")
        vsb.grid(row=0, column=1, sticky="ns")
        hsb.grid(row=1, column=0, sticky="ew")

        table_container.grid_rowconfigure(0, weight=1)
        table_container.grid_columnconfigure(0, weight=1)

        style = ttk.Style()
        style.theme_use("clam")

        style.configure("Treeview",
                        background=self.colors["light_bg"],
                        foreground=self.colors["dark_text"],
                        fieldbackground=self.colors["light_bg"],
                        rowheight=30,
                        font=('Segoe UI', 11),
                        borderwidth=1,
                        relief="solid")

        style.configure("Treeview.Heading",
                        background=self.colors["table_header"],
                        foreground="white",
                        relief="flat",
                        font=('Segoe UI', 12, 'bold'),
                        padding=10)

        style.map("Treeview",
                  background=[('selected', '#e6f2ff')],
                  foreground=[('selected', self.colors["dark_text"])])

        self.results_tree.tag_configure("critical",
                                        background="#ffcccc",
                                        foreground=self.colors["dark_text"])

        self.results_tree.tag_configure("warning",
                                        background="#fff2cc",
                                        foreground=self.colors["dark_text"])

        self.results_tree.tag_configure("normal",
                                        background="#d9ead3",
                                        foreground=self.colors["dark_text"])

        self.results_tree.tag_configure("uncertain",
                                        background="#f0f0f0",
                                        foreground=self.colors["dark_text"])

        self.results_tree.tag_configure("error",
                                        background="#f8d7da",
                                        foreground=self.colors["dark_text"])

        self.results_tree.bind("<<TreeviewSelect>>", self.show_preview)

    def setup_single_tab(self):
        main_container = ctk.CTkFrame(self.tab_single, fg_color=self.colors["light_bg"])
        main_container.pack(fill="both", expand=True, padx=5, pady=5)

        left_panel = ctk.CTkFrame(main_container, width=400,
                                  fg_color=self.colors["light_bg"])
        left_panel.pack(side="left", fill="y", padx=(0, 10), pady=5)

        right_panel = ctk.CTkFrame(main_container, fg_color=self.colors["light_bg"])
        right_panel.pack(side="right", fill="both", expand=True, padx=5, pady=5)

        ctk.CTkLabel(left_panel, text="–ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
                     font=self.heading_font,
                     text_color=self.colors["dark_text"]).pack(pady=20, padx=20)

        image_frame = ctk.CTkFrame(left_panel, height=300,
                                   fg_color="#f0f0f0", corner_radius=10)
        image_frame.pack(fill="x", padx=20, pady=15)
        image_frame.pack_propagate(False)

        self.single_image_label = ctk.CTkLabel(image_frame,
                                               text="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                                               text_color=self.colors["gray_text"])
        self.single_image_label.pack(expand=True)

        ctk.CTkButton(left_panel, text="üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                      command=self.load_single_image,
                      height=40, fg_color=self.colors["primary"],
                      text_color="white").pack(pady=10, padx=20)

        settings_frame = ctk.CTkFrame(left_panel, fg_color="#f9f9f9")
        settings_frame.pack(fill="x", padx=20, pady=20)

        ctk.CTkLabel(settings_frame, text="–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:",
                     text_color=self.colors["dark_text"]).pack(pady=(10, 5), padx=10)

        self.single_confidence_slider = ctk.CTkSlider(settings_frame, from_=0, to=100,
                                                      number_of_steps=100,
                                                      progress_color=self.colors["primary"])
        self.single_confidence_slider.set(60)
        self.single_confidence_slider.pack(fill="x", padx=10, pady=5)

        self.single_confidence_label = ctk.CTkLabel(settings_frame, text="60%",
                                                    text_color=self.colors["dark_text"])
        self.single_confidence_label.pack()

        self.single_confidence_slider.configure(command=self.update_single_confidence_label)

        ctk.CTkButton(left_panel, text="üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                      command=self.analyze_single_image,
                      height=45, fg_color=self.colors["success"],
                      text_color="white", font=self.heading_font).pack(pady=20, padx=20, fill="x")

        ctk.CTkLabel(right_panel, text="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞",
                     font=self.heading_font,
                     text_color=self.colors["dark_text"]).pack(pady=20, padx=20, anchor="w")

        results_frame = ctk.CTkFrame(right_panel, fg_color="#f9f9f9",
                                     border_width=1, border_color=self.colors["border"])
        results_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))

        self.result_text = ctk.CTkTextbox(results_frame, height=300,
                                          font=self.normal_font,
                                          text_color=self.colors["dark_text"])
        self.result_text.pack(fill="both", expand=True, padx=10, pady=10)

        self.result_text.insert("1.0", "–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞...\n\n")
        self.result_text.insert("end", "1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n")
        self.result_text.insert("end", "2. –ù–∞–∂–º–∏—Ç–µ '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å'\n")
        self.result_text.insert("end", "3. –°–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–¥–µ—Å—å\n\n")
        self.result_text.configure(state="disabled")

    def setup_status_bar(self):
        self.status_bar = ctk.CTkLabel(self.window, text="–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...",
                                       anchor="w", font=self.small_font,
                                       text_color=self.colors["dark_text"])
        self.status_bar.pack(side="bottom", fill="x", padx=10, pady=5)

    def update_confidence_label(self, value):
        self.confidence_label.configure(text=f"{float(value):.0f}%")

    def update_single_confidence_label(self, value):
        self.single_confidence_label.configure(text=f"{float(value):.0f}%")

    def select_folder(self):
        folder_path = filedialog.askdirectory(title="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏")
        if folder_path:
            self.current_folder = folder_path
            folder_name = os.path.basename(folder_path)
            self.folder_label.configure(text=folder_name[:30] + "..." if len(folder_name) > 30 else folder_name)
            self.scan_folder()

    def scan_folder(self):
        if not self.current_folder:
            return

        extensions = ['*.jpg', '*.jpeg', '*.png', '*.bmp', '*.tiff', '*.tif']
        self.image_files = []

        for ext in extensions:
            self.image_files.extend(glob.glob(os.path.join(self.current_folder, ext)))
            self.image_files.extend(glob.glob(os.path.join(self.current_folder, ext.upper())))

        self.image_files = list(set(self.image_files))
        self.image_files.sort()

        count = len(self.image_files)
        if count == 0:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!")
            self.status_bar.configure(text="–ü–∞–ø–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
        else:
            messagebox.showinfo("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", f"–ù–∞–π–¥–µ–Ω–æ {count} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            self.status_bar.configure(text=f"–ù–∞–π–¥–µ–Ω–æ {count} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")

    def start_batch_analysis(self):
        if not self.image_files:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏!")
            return

        if self.model_status != "loaded":
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å.")
            return

        for item in self.results_tree.get_children():
            self.results_tree.delete(item)
        self.results = []

        self.stop_analysis_flag = False
        self.stop_button.configure(state="normal")

        self.analysis_thread = threading.Thread(target=self.process_images)
        self.analysis_thread.daemon = True
        self.analysis_thread.start()

    def process_images(self):
        total = len(self.image_files)
        processed = 0

        threshold = self.confidence_slider.get() / 100.0

        for image_path in self.image_files:
            if self.stop_analysis_flag:
                break

            try:
                result_dict = self.analyze_single_image_internal(image_path, threshold)
                self.results.append(result_dict)

                processed += 1
                progress = processed / total

                self.window.after(0, self.update_progress, progress, processed, total)
                self.window.after(0, self.add_result_to_table, result_dict)

                time.sleep(0.01)

            except Exception:
                error_result = {
                    "file": os.path.basename(image_path),
                    "result": "error",
                    "confidence": 0,
                    "status": "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏",
                    "timestamp": datetime.now().strftime("%H:%M:%S"),
                    "path": image_path
                }
                self.window.after(0, self.add_result_to_table, error_result)

        self.window.after(0, self.analysis_complete)

    def analyze_single_image_internal(self, image_path, threshold=0.6):
        result, confidence, _ = self.classifier.predict_image(image_path, threshold)

        if result is None:
            return {
                "file": os.path.basename(image_path),
                "result": "error",
                "confidence": 0,
                "status": "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞",
                "timestamp": datetime.now().strftime("%H:%M:%S"),
                "path": image_path
            }

        if result == 'uncertain':
            status = "‚ùì –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
        elif result == 'crack':
            if confidence > 0.8:
                status = "‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ (—Ç—Ä–µ—â–∏–Ω—ã)"
            else:
                status = "‚ö†Ô∏è –¢—Ä–µ—â–∏–Ω–∞"
        elif result == 'corrosion':
            if confidence > 0.8:
                status = "‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ (–∫–æ—Ä—Ä–æ–∑–∏—è)"
            else:
                status = "‚ö†Ô∏è –ö–æ—Ä—Ä–æ–∑–∏—è"
        elif result == 'normal':
            status = "‚úÖ –ù–æ—Ä–º–∞"
        else:
            status = f"‚ùì {result}"

        return {
            "file": os.path.basename(image_path),
            "result": result,
            "confidence": confidence,
            "status": status,
            "timestamp": datetime.now().strftime("%H:%M:%S"),
            "path": image_path
        }

    def update_progress(self, progress, current, total):
        self.progress_bar.set(progress)
        self.progress_label.configure(text=f"{current}/{total} ({progress * 100:.1f}%)")
        self.status_bar.configure(text=f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {current}/{total}")

    def add_result_to_table(self, result):
        if isinstance(result['confidence'], (int, float)):
            confidence_str = f"{result['confidence'] * 100:.1f}%"
        else:
            confidence_str = str(result['confidence'])

        item = self.results_tree.insert("", "end", values=(
            result["file"],
            result["result"],
            confidence_str,
            result["status"],
            result["timestamp"]
        ))

        status = result["status"]
        if "–ö—Ä–∏—Ç–∏—á–Ω–æ" in status:
            tag = "critical"
        elif "‚ö†Ô∏è" in status:
            tag = "warning"
        elif "‚úÖ" in status:
            tag = "normal"
        elif "‚ùì" in status:
            tag = "uncertain"
        elif "‚ùå" in status:  # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê: –±—ã–ª —Ä—É—Å—Å–∫–∏–π "–≤", —Ç–µ–ø–µ—Ä—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π "in"
            tag = "error"
        else:
            tag = "normal"

        self.results_tree.item(item, tags=(tag,))
        self.results_tree.see(item)

    def show_preview(self, event):
        selection = self.results_tree.selection()
        if not selection:
            return

        item = self.results_tree.item(selection[0])
        filename = item['values'][0]

        for result in self.results:
            if result["file"] == filename:
                image_path = result["path"]
                break
        else:
            self.preview_label.configure(image="", text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        try:
            img = Image.open(image_path)
            max_size = (400, 200)
            img.thumbnail(max_size, Image.Resampling.LANCZOS)

            img_ctk = ctk.CTkImage(light_image=img, dark_image=img,
                                   size=(img.width, img.height))

            self.preview_label.configure(image=img_ctk, text="")
            self.preview_label.image = img_ctk

        except Exception:
            self.preview_label.configure(image="", text="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")

    def stop_analysis(self):
        self.stop_analysis_flag = True
        self.stop_button.configure(state="disabled")
        self.status_bar.configure(text="–ê–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")

    def analysis_complete(self):
        self.stop_button.configure(state="disabled")

        total = len(self.results)
        success = sum(1 for r in self.results if r["result"] not in ["error", None])

        self.status_bar.configure(text=f"–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –£—Å–ø–µ—à–Ω–æ: {success}/{total}")
        messagebox.showinfo("–ó–∞–≤–µ—Ä—à–µ–Ω–æ",
                            f"–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n"
                            f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {total}\n"
                            f"–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {success}\n\n"
                            f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ.")

    def load_single_image(self):
        file_path = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
            filetypes=[
                ("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "*.jpg *.jpeg *.png *.bmp *.tiff *.tif"),
                ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")
            ]
        )

        if file_path:
            self.single_image_path = file_path
            try:
                img = Image.open(file_path)
                max_size = (350, 300)
                img.thumbnail(max_size, Image.Resampling.LANCZOS)

                img_ctk = ctk.CTkImage(light_image=img, dark_image=img,
                                       size=(img.width, img.height))

                self.single_image_label.configure(image=img_ctk, text="")
                self.single_image_label.image = img_ctk

                self.status_bar.configure(text=f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {os.path.basename(file_path)}")

            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:\n{e}")

    def analyze_single_image(self):
        if not hasattr(self, 'single_image_path'):
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!")
            return

        if self.model_status != "loaded":
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å.")
            return

        try:
            threshold = self.single_confidence_slider.get() / 100.0
            result = self.analyze_single_image_internal(self.single_image_path, threshold)

            self.result_text.configure(state="normal")
            self.result_text.delete("1.0", "end")

            result_text = f"{'=' * 50}\n"
            result_text += "–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê\n"
            result_text += f"{'=' * 50}\n\n"

            result_text += f"üìÅ –§–∞–π–ª: {result['file']}\n"
            result_text += f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {result['result'].upper()}\n"
            result_text += f"üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result['confidence'] * 100:.1f}%\n"
            result_text += f"üìà –°—Ç–∞—Ç—É—Å: {result['status']}\n"
            result_text += f"‚è∞ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {result['timestamp']}\n\n"

            result_text += f"{'=' * 50}\n"
            result_text += "–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò\n"
            result_text += f"{'=' * 50}\n\n"

            if result['result'] == 'crack':
                if result['confidence'] > 0.8:
                    result_text += "üö® –í–´–°–û–ö–ò–ô –†–ò–°–ö! –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —á–µ—Ç–∫–∏–µ —Ç—Ä–µ—â–∏–Ω—ã.\n"
                    result_text += "   –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Å–º–æ—Ç—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ —Ä–µ–º–æ–Ω—Ç.\n"
                else:
                    result_text += "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç—Ä–µ—â–∏–Ω—ã.\n"
                    result_text += "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.\n"

            elif result['result'] == 'corrosion':
                if result['confidence'] > 0.8:
                    result_text += "‚ö†Ô∏è –°–ò–õ–¨–ù–ê–Ø –ö–û–†–†–û–ó–ò–Ø! –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–æ–∑–∏—è.\n"
                    result_text += "   –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏.\n"
                else:
                    result_text += "üü° –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–∞—è –∫–æ—Ä—Ä–æ–∑–∏—è.\n"
                    result_text += "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è.\n"

            elif result['result'] == 'normal':
                result_text += "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –Ω–æ—Ä–º–µ. –î–µ—Ñ–µ–∫—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.\n"
                result_text += "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–ª–∞–Ω–æ–≤—ã–π –æ—Å–º–æ—Ç—Ä.\n"

            elif result['result'] == 'uncertain':
                result_text += "‚ùì –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –Ω–∏–∑–∫–∞—è.\n"
                result_text += "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.\n"

            else:
                result_text += "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n"
                result_text += "   –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.\n"

            self.result_text.insert("1.0", result_text)
            self.result_text.configure(state="disabled")

            self.status_bar.configure(text=f"–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω: {result['file']}")

        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:\n{e}")

    def export_results(self):
        if not self.results:
            messagebox.showwarning("–û—à–∏–±–∫–∞", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!")
            return

        file_path = filedialog.asksaveasfilename(
            title="–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
            defaultextension=".xlsx",
            filetypes=[
                ("Excel —Ñ–∞–π–ª—ã", "*.xlsx"),
                ("CSV —Ñ–∞–π–ª—ã", "*.csv"),
                ("JSON —Ñ–∞–π–ª—ã", "*.json"),
                ("–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã", "*.txt")
            ]
        )

        if not file_path:
            return

        try:
            export_data = []
            for result in self.results:
                export_data.append({
                    "–§–∞–π–ª": result["file"],
                    "–†–µ–∑—É–ª—å—Ç–∞—Ç": result["result"],
                    "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å": f"{result['confidence'] * 100:.1f}%" if isinstance(result['confidence'],
                                                                                      (int, float)) else result[
                        'confidence'],
                    "–°—Ç–∞—Ç—É—Å": result["status"],
                    "–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞": result["timestamp"],
                    "–ü—É—Ç—å": result.get("path", "")
                })

            df = pd.DataFrame(export_data)

            if file_path.endswith('.xlsx'):
                df.to_excel(file_path, index=False)
            elif file_path.endswith('.csv'):
                df.to_csv(file_path, index=False, encoding='utf-8-sig')
            elif file_path.endswith('.json'):
                df.to_json(file_path, orient='records', force_ascii=False, indent=2)
            elif file_path.endswith('.txt'):
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write("=" * 60 + "\n")
                    f.write("–û–¢–ß–ï–¢ –ê–ù–ê–õ–ò–ó–ê –î–ï–§–ï–ö–¢–û–í\n")
                    f.write("=" * 60 + "\n\n")

                    for item in export_data:
                        f.write(f"–§–∞–π–ª: {item['–§–∞–π–ª']}\n")
                        f.write(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {item['–†–µ–∑—É–ª—å—Ç–∞—Ç']}\n")
                        f.write(f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {item['–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å']}\n")
                        f.write(f"–°—Ç–∞—Ç—É—Å: {item['–°—Ç–∞—Ç—É—Å']}\n")
                        f.write(f"–í—Ä–µ–º—è: {item['–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞']}\n")
                        f.write("-" * 40 + "\n")

            messagebox.showinfo("–£—Å–ø–µ—Ö", f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤:\n{file_path}")
            self.status_bar.configure(text=f"–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: {os.path.basename(file_path)}")

        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:\n{e}")

    def reload_model(self):
        self.status_bar.configure(text="–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...")
        self.model_status_label.configure(text="üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...", text_color="#FF9800")

        self.select_model_file()

    def run(self):
        self.window.mainloop()


def main_menu():
    menu_window = ctk.CTk()
    menu_window.title("SkyChecker - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    menu_window.geometry("500x450")

    menu_window.update_idletasks()
    width = menu_window.winfo_width()
    height = menu_window.winfo_height()
    x = (menu_window.winfo_screenwidth() // 2) - (width // 2)
    y = (menu_window.winfo_screenheight() // 2) - (height // 2)
    menu_window.geometry(f'{width}x{height}+{x}+{y}')

    try:
        menu_window.tk.call('tk', 'scaling', 1.0)
    except:
        pass

    title_font = ctk.CTkFont(size=32, weight="bold", family="Segoe UI")
    subtitle_font = ctk.CTkFont(size=16, family="Segoe UI")

    ctk.CTkLabel(menu_window, text="SkyChecker",
                 font=title_font, text_color="#4a86e8").pack(pady=40)

    ctk.CTkLabel(menu_window, text="–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ—â–∏–Ω –∏ –∫–æ—Ä—Ä–æ–∑–∏–∏ –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö",
                 font=subtitle_font, text_color="#666666").pack(pady=5)

    model_exists = any([
        os.path.exists("models/–ø–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å.pth"),
        os.path.exists("models/–º–æ–¥–µ–ª—å.pth"),
        os.path.exists("–ø–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å.pth"),
        os.path.exists("–º–æ–¥–µ–ª—å.pth")
    ])

    for root, dirs, files in os.walk("."):
        for file in files:
            if file.endswith('.pth') or file.endswith('.pt'):
                if 'cache' in root or '__pycache__' in root:
                    continue
                model_exists = True
                break
        if model_exists:
            break

    status_color = "#4CAF50" if model_exists else "#FF9800"
    status_text = "‚úÖ –ú–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞" if model_exists else "‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

    status_frame = ctk.CTkFrame(menu_window, fg_color="#f0f7ff", corner_radius=10)
    status_frame.pack(pady=20, padx=40, fill="x")

    ctk.CTkLabel(status_frame, text="–°—Ç–∞—Ç—É—Å:",
                 font=ctk.CTkFont(weight="bold"), text_color="#000000").pack(pady=(10, 2))
    ctk.CTkLabel(status_frame, text=status_text, text_color=status_color,
                 font=ctk.CTkFont(size=14, weight="bold")).pack(pady=(0, 10))

    start_button = ctk.CTkButton(
        menu_window,
        text="üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
        command=lambda: [menu_window.destroy(), NeuralNetworkApp().run()],
        height=50,
        width=250,
        font=ctk.CTkFont(size=16, weight="bold"),
        fg_color="#4a86e8",
        hover_color="#3a76d8",
        text_color="white"
    )
    start_button.pack(pady=30)

    ctk.CTkButton(
        menu_window,
        text="–í—ã—Ö–æ–¥",
        command=menu_window.destroy,
        height=40,
        width=150,
        fg_color="#666666",
        text_color="white"
    ).pack(pady=10)

    ctk.CTkLabel(menu_window, text="–í–µ—Ä—Å–∏—è 2.2 | 2026 SkyChecker",
                 text_color="#999999").pack(side="bottom", pady=10)

    menu_window.mainloop()


if __name__ == "__main__":
    main_menu()
